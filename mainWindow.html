<!DOCTYPE html>
<html lang="en">
<head>
    <title>p2pchat</title>
    <script>
        const electron = require('electron');
        const {ipcRenderer} = electron;
        var peers  = [];
        var name = "";

        ipcRenderer.on('setName', (event, arg) => {
            name = arg.name;
            console.log("recieved setname. name is: ", arg[0]);
        });

        ipcRenderer.on('peer:connect', (event, arg) => {
            console.log("inside peer:connect peer is", arg[0]);
            var node = document.createElement("LI");
            var textnode = document.createTextNode("you are now connected to: " + arg[0].id.toB58String());
            node.appendChild(textnode);
            document.getElementById("chat-list").appendChild(node);
            peers.push(arg.peer);
        });

        ipcRenderer.on('recieve', (event, arg) => {
            console.log("entered recieve callback...");
            console.log("variables are: ", arg);
            displayMessage(arg[0], arg[1], arg[2]);
        });

        function sendToMain(message) {
            ipcRenderer.send('message:send', message);
            console.log("sent message to main.js");
        }

        function getCurrentTime() {
            return new Date();
        }

        function parseTime(timeStr) {
            var year = timeStr.substr(0, 3);
            var month = timeStr.substr(5, 6);
            var day = timeStr.substr(8, 9);
            var hours = timeStr.substr(11, 12);
            var minutes = timeStr.substr(14, 15);

            var date = new Date()
            date.setFullYear(parseInt(year, 10));
            date.setMonth(parseInt(month, 10));
            date.setDate(parseInt(day, 10));
            date.setHours(parseInt(hours, 10));
            date.setMinutes(parseInt(minutes, 10));
            return date;
        }

        function formatTime(timeString) {
            var time = parseTime(timeString);
            var currentTime = getCurrentTime();
            //if the current time is more than 25 hours later than the time of message then display date
            if (time.getHours() - currentTime.getHours() > 25) {
                return (time.getMonth()+1 + '/' + time.getDate());
            }
            else {
                return (time.getHours() + ":" + time.getMinutes() + ":");
            }
        }

        function displayMessage(message, time, displayName) {
            console.log("inside displaymessage");
            var node = document.createElement("LI");
            var textnode = document.createTextNode(displayName + ": " + formatTime(time) + " " + message);
            node.appendChild(textnode);
            document.getElementById("chat-list").appendChild(node);
        }

        function sendEnter(e) {
            if (e.keyCode == 13) {
                //get message and add time code 
                var message = document.getElementById("textarea").value;
                var time = getCurrentTime();
                var package = {
                    message, 
                    time
                };
                sendToMain(package);

                //update display
                displayMessage(package.message, package.time, name);
                
                //remove text in chat text window
                document.getElementById("textarea").value = '';
            }
        }
        function send() {
            //get message and add time code 
            var message = document.getElementById("textarea").value;
            var time = getCurrentTime();
            var package = {
                message,
                time
            };
            sendToMain(package);

            //update display
            displayMessage(package.message, package.time, name);

            //remove text in chat text window
            document.getElementById("textarea").value = '';
        }
    </script>
</head>
<body>
    <div class = "chat-window">
        <ul id = "chat-list">

        </ul>
    </div>
    <input type = "textarea" name = "message" id = "textarea" onkeypress = "sendEnter(event)" value = "" autofocus>
    <input type = "button" name = "send" value = "Send" id = "sendButton" onclick = "send(event)">
</body>
</html>